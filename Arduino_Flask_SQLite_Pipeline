from flask import Flask, request, jsonify
import sqlite3
import threading
import logging

def create_db_and_table(db_name):
    conn = sqlite3.connect(db_name)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS SensorData (
                 id INTEGER PRIMARY KEY AUTOINCREMENT,
                 temperature REAL,
                 pressure REAL,
                 humidity REAL,
                 timestamp DATETIME DEFAULT CURRENT_TIMESTAMP)''')
    conn.commit()
    conn.close()

create_db_and_table('sensor_data.db')

app = Flask(__name__)

def stop_server():
    print("Stopping server after 2 hours...")
    func = request.environ.get('werkzeug.server.shutdown')
    if func is None:
        raise RuntimeError('Not running with the Werkzeug Server')
    func()

logging.basicConfig(level=logging.DEBUG)

@app.route('/api/data', methods=['POST'])
def post_data():
    try:
        content = request.json
        temperature = content.get('temperature')
        pressure = content.get('pressure')
        humidity = content.get('humidity')

        if None in [temperature, pressure, humidity]:
            return jsonify({"result": "failure", "reason": "Missing values"}), 400

        with sqlite3.connect('sensor_data.db') as conn:
            c = conn.cursor()
            c.execute("INSERT INTO SensorData (temperature, pressure, humidity) VALUES (?, ?, ?)",
                      (temperature, pressure, humidity))
            conn.commit()

        return jsonify({"result": "success"}), 201

    except sqlite3.Error as e:
        print(f"SQLite error: {e}")
        return jsonify({"result": "failure", "reason": str(e)}), 500

    except Exception as e:
        print(f"General error: {e}")
        return jsonify({"result": "failure", "reason": "An unknown error occurred"}), 500

if __name__ == '__main__':
    t = threading.Timer(7200.0, stop_server)
    t.start()
    app.run(host='0.0.0.0', port=5000)
